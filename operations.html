<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossfire - Purchasing</title>
    <link rel="stylesheet" href="styles/style.css">
</head>

<body>
    <header>
    <div id="logoutButtonContainer" style="display: none;">
        <button id="logoutButton">Logout</button>
    </div>

    <div>


        <img src="images/CrossfireLogo.png" alt="Bold Crossfire logo" width="650" height="700">
        <div id="notifications" style="position: fixed; top: 10px; left: 10px; cursor: pointer;">
            <img src="images/notif-icon.png" alt="Notifications" id="notifIcon" />
            <span id="notifBadge" style="background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; display: none;">0</span>
            <div id="notifDropdown" style="display: none; position: absolute; top: 100px; left: -10px; background: white; border: 1px solid #ccc; padding: 10px; max-width: 300px;">
                <h4>Notifications</h4>
                <ul id="notifList" style="list-style: none; padding: 0; margin: 0;"></ul>
            </div>
        </div>
            
        <!--User Profile Section-->
        <div id="profileSection" >
            <img src="images/person-circle.svg" alt="User Profile" id="profileIcon" style="width: 40px; height: 40px; border-radius: 50%;" />
            <div id="profileDropdown" style="display: none; background: white; border: 1px solid #ccc; padding: 10px; max-width: 200px;">
                <p id="profileName" style="margin: 0; font-weight: bold;">Role: User Name</p>
                <p id="profileEmail" style="margin: 0; font-size: 14px; color: gray;">Email: email@example.com</p>
            </div>
        </div>

        </header>

        <iframe src="navbar.html" style="width: 100%; border: none; height: 56px; overflow: hidden;"></iframe>

        <div id="modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div id="formContainer">
                    <div id="loginForm">
                        <h2>Login</h2>
                        <input type="email" placeholder="(ex) johnwick@kickbutt.ca" required>
                        <input type="password" placeholder="(ex) ThisIsMyPassword123" required>
                        <button id="loginButton">Login</button>
                        <p>No account? <a href="#" id="showRegister">Register</a></p>
                    </div>
                    <div id="registerForm" style="display:none;">
                        <h2>Register</h2>
                        <input type="text" placeholder="(ex) ThisIsMyUserName" required>
                        <input type="email" placeholder="Email" required>
                        <input type="password" placeholder="Password" required>
                        <button id="registerButton">Register</button>
                        <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
                    </div>
                </div>
            </div>
        </div>
        <main>
            <h1>Operations - NCR Form</h1>
            <p>All required fields marked with a (*)</p>
            <div id="form-sections">
                <form action="https://webdevbasics.net/scripts/demo.php" method="post" enctype="multipart/form-data">
                    <div id="formContainer">
                        <fieldset class="supplier-product-info">

                            <legend>Supplier and Product Info.</legend>
                            <div>
                                <label for="supName">Supplier Name*</label>
                                <input id="supName" name="supName" placeholder="Pepsi Co.." type="text" required>
                                <span id="supNameError" style="color: red;"></span>
                            </div>
                            <div>
                                <label for="ncrNo">NCR No.*</label>
                                <input id="ncrNo" name="ncrNo" placeholder="65789" type="text" required>
                                <span id="ncrNoError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <label for="prodNo">PO or Prod. No.*</label>
                                <input id="prodNo" name="prodNo" placeholder="product number" type="text" required>
                                <span id="prodNoError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <label for="saleOrderNo">Sales Order No.*</label>
                                <input id="saleOrderNo" name="saleOrderNo" placeholder="9998877" type="text" required>
                                <span id="saleOrderNoError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <label for="quantityR">Quantity Received:*</label>
                                <input id="quantityR" name="quantityR" placeholder="10" type="text" required>
                                <span id="quantityRError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <label for="quantityD">Quantity Defective*</label>
                                <input id="quantityD" name="quantityD" placeholder="15" type="text" required>
                                <span id="quantityDError" style="color: red;"></span> <!-- Error span -->
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend>Report Details</legend>
                            <div>
                                <label>Identify Process applicable:</label>
                                <br>
                                <div>
                                    <label for="rdoIPA">Supplier or Rec-Insp*</label>
                                    <input type="radio" id="rdoIPA" name="rdoRecWIP" value="recInsp">
                                
                                    <label for="rdoWIP">WIP(Production Order)*</label>
                                    <input type="radio" id="rdoWIP" name="rdoRecWIP" value="WIP">
                                </div>
                                <span id="rdoIPAError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <br>
                            <div>
                                <label for="sapNo">SAP No.*</label>
                                <input id="sapNo" name="sapNo" placeholder="SAP No. here" type="text" required>
                                <span id="sapNoError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <label for="itemDescription">Description of Item*</label>
                                <textarea id="itemDescription" name="itemDescription"
                                    placeholder="Please describe the item here" required></textarea>
                                <span id="itemDescriptionError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <label for="defectDescription">Description of Defect*</label>
                                <textarea id="defectDescription" name="defectDescription"
                                    placeholder="In as much detail possible, describe the item's defect"
                                    required></textarea>
                                <span id="defectDescriptionError" style="color: red;"></span> <!-- Error span -->
                            </div>                            
                        </fieldset>

                        <fieldset>
                            <div class="radio-group">
                                <label>Item marked Nonconforming*</label>
                                <label for="rdoConformingYes">Yes</label>
                                <input type="radio" id="rdoConformingYes" name="conforming" value="Yes">
                                <label for="rdoConformingNo">No</label>
                                <input type="radio" id="rdoConformingNo" name="conforming" value="No">
                                <span id="rdoConformingError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <label for="reportDate">Date of Report*</label>
                                <input id="reportDate" name="reportDate" type="date" required>
                                <span id="reportDateError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <label for="repName">Quality Representative's Name:*</label>
                                <input type="text" id="repName" name="repName" placeholder="John Wick" required>
                                <span id="repNameError" style="color: red;"></span> <!-- Error span -->
                            </div>                            
                        </fieldset>
                        <fieldset>
                            <Legend>Engineering - Action</Legend>
                            <div>
                                <label for="selectDisposition">Review by CF Engineer*</label>

                                <select id="selectDisposition" required>

                                    <option value="UseAsIs">Use as Is</option>
                                    <option value="repair">Repair</option>
                                    <option value="rework">Rework</option>
                                    <option value="scrap">Scrap</option>
                                </select>
                            </div>
                            <div>
                                <label for="dispositionDescription">Disposition Description*</label>
                                <textarea id="dispositionDescription" name="dispositionDescription"
                                    placeholder="(ex)Sequence of work steps required when 'repair' or 'rework' indicated"
                                    required></textarea>
                                <span id="dispositionError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <label for="selectNotification">Does Customer require notification?* y/n?</label>
                                <p>If "Yes" raise message to customer detailing issues</p>
                                <select id="selectNotification" required>
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>
                            <div class="radio-group">
                                <label>Does the drawing require updating?*</label>
                                <label for="rdoRedrawYes">Yes</label>
                                <input type="radio" id="rdoRedrawYes" name="redraw" value="Yes" >
                                <label for="rdoRedrawNo">No</label>
                                <input type="radio" id="rdoRedrawNo" name="redraw" value="No" >
                                <span id="rdoDrawingError" style="color: red;"></span> <!-- Error span -->
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Engineering - Details</legend>
                            <div>
                                <label for="txtOrgRevNo">Original Rev. Number*</label>
                                <input type="text" id="txtOrgRevNo" name="txtOrgRevNo" placeholder="(ex)5556667722" required>
                            </div>
                            <div>
                                <label for="txtUpRevNo">Updated Rev. Number</label>
                                <input type="text" id="txtUpRevNo" name="txtUpRevNo" placeholder="(ex)5556667722">
                            </div>
                            <div>
                                <label for="revisionDate">Revision Date*</label>
                                <input id="revisionDate" name="revisionDate" type="date" required>
                                <span id="revisionDateError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <label for="txtEngName">Name of Engineer*</label>
                                <input type="text" id="txtEngName" name="txtEngName" placeholder="(ex)Imma DaBoss"
                                    required>
                                <span id="txtEngNameError" style="color: red;"></span> <!-- Error span -->
                            </div>
                        </fieldset>
                    </div>
                    <div id="formContainer">
                        <fieldset>
                            <legend>Operations - Action</legend>
                            <div>
                                <label for="purchDecision">Purchasing's Prelim Decision*</label>
                                <select id="purchDecision" required>
                                    <option value="return">Return To Supplier</option>
                                    <option value="rwkInHouse">Rework in House</option>
                                    <option value="scrpInHouse">Scrap in House</option>
                                    <option value="Defer">Defer for HBC Engineering Review</option>
                                </select>
                            </div>
                            <div>
                                <label for="CAR">Was a CAR raised?*</label>

                                <select id="CAR" required>

                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select required>
                                <span id="CARError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <p>If "Yes" indicate CAR#</p>

                                <label for="carNumber">CAR No.*</label>
                                <input type="text" id="carNumber" name="carNumber" placeholder="(ex)optional CAR NO" required>

                            </div>
                            <div>
                                <label for="followUp">Follow-Up Required?*</label>
                                <select id="followUp" required>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div>
                                <label for="txtFollowUp">If "Yes" supply type of follow up and expected date</label>
                                <input type="text" id="txtFollowUp" name="newNCRNO" placeholder="Type of follow up and expected date">
                            </div>                    
                            
                            <div>
                                <label for="txtOpName">Operations Manager*</label>
                                <input type="text" id="txtOpName" name="txtOpName" placeholder="(ex)Imma DaBoss"
                                    required>
                                <span id="txtOpNameError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <label for="operationsDate">Revision Date*</label>
                                <input id="operationsDate" name="revisionDate" type="date" required>
                                <span id="operationsDateError" style="color: red;"></span> <!-- Error span -->
                            </div>
                        </fieldset>
                    </div>
                    <div id="formContainer">
                        <fieldset>
                            <legend>Final</legend>
                            <div>
                                <label for="reInspect">Re-Inspected Acceptable?*</label>
                                <select id="reInspect">
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select required>
                                <span id="reInspectError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <div>
                                <p>If "No" then record new NCR number</p>
                                <label for="newNCRnumber">New NCR No.*</label>
                                <input type="text" id="newNCRnumber" name="newNCRnumber"
                                    placeholder="(ex)new NCR number" required>
                            </div>
                            <hr>                            
                            <div>
                                <label for="finalInspectorDate">Purchasing's Name*</label>
                                <input id="finalInspectorDate" name="inspectorDate" type="date">
                                <span id="finalInspectorDateError" style="color: red;"></span> <!-- Error span -->
                            </div>
                            <hr>                            
                            <div>
                                <label for="qualityDate">Quality Dept Date*</label>
                                <input id="qualityDate" name="inspectorDate" type="date" required>
                                <span id="qualityDateError" style="color: red;"></span> <!-- Error span -->
                            </div>
                        </fieldset>
                    </div>
                    <div class="button-container">
                        <label for="status">Mark Status Closed?:*</label>
                        <select id="status" required>

                            <option value="Open">Active</option>
                            <option value="Closed">Closed</option>
                        </select>
                        <button type="button" id="btnSave" value="Save Report" title="Save and close out the">Save & Close</button>                        
                        <button type="button" id="btnClear" value="Clear Report">Clear</button>

                    </div>
                </form>
            </div>
        </main>
    </div>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

    <script src="scripts/app.js"></script>
    <script src="scripts/session.js"></script>
    <script src="scripts/homeLogin.js"></script>
    <script src="scripts/notif.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {            
            const passedNCR = new URLSearchParams(window.location.search).get('ncr');
            var index = -1;
            if (passedNCR !== null) {
                const storedNCRs = JSON.parse(localStorage.getItem('storedNCRs')) || [];
                //console.log(storedNCRs);
               storedNCRs.forEach(element => {
                    if (element.supplierInfo.ncrNumber === passedNCR) index = storedNCRs.indexOf(element);
               });

               if (index !=-1){
                var ncr = storedNCRs[index];
                }            
               

                if (ncr) {
                    document.getElementById('supName').value = ncr.supplierInfo.supplierName;
                    document.getElementById('ncrNo').value = ncr.supplierInfo.ncrNumber;
                    document.getElementById('prodNo').value = ncr.supplierInfo.poOrProductNumber;
                    document.getElementById('saleOrderNo').value = ncr.supplierInfo.salesOrderNumber;
                    document.getElementById('quantityR').value = ncr.supplierInfo.quantityReceived;
                    document.getElementById('quantityD').value = ncr.supplierInfo.quantityDefective;
                    document.getElementById('sapNo').value = ncr.reportDetails.sapNo;
                    document.getElementById('repName').value = ncr.nonConformanceDetails.qualityRepresentativeName;
                    
                    

                    // Populating Report Details (Non-Conforming and Redraw)
                    if (ncr.reportDetails.isNonConforming === 'Yes') {
                        document.getElementById('rdoConformingYes').checked = true;
                    } else {
                        document.getElementById('rdoConformingNo').checked = true;
                    }

                    if (ncr.reportDetails.redraw === 'Yes') {
                        document.getElementById('rdoRedrawYes').checked = true;
                    } else {
                        document.getElementById('rdoRedrawNo').checked = true;
                    }

                    if(ncr.reportDetails.processApplicable === 'recInsp'){
                        document.getElementById('recInsp').checked = true;
                    }else {
                        document.getElementById('rdoWIP').checked = true;
                    }

                    // Populating Date and Name
                    const reportDate = ncr.reportDetails.reportDate;
                    if (reportDate) {
                        // Ensure the date format is YYYY-MM-DD for the input[type="date"]
                        const formattedDate = new Date(reportDate).toISOString().split('T')[0]; // Get YYYY-MM-DD part
                        console.log(formattedDate); // Check the formatted date

                        // Setting the value directly to input[type="date"]
                        document.getElementById('reportDate').value = formattedDate;

                        // This should update the calendar and text display for date pickers
                    }
                    
                    

                    // Populating Description Fields
                    document.getElementById('itemDescription').value = ncr.reportDetails.itemDescription;
                    document.getElementById('defectDescription').value = ncr.reportDetails.descriptionOfDefect;
                    
                    //Engineering fieds.
                    document.getElementById('dispositionDescription').value = ncr.reportDetails.dispositionDescription;
                    document.getElementById('selectDisposition').value = ncr.reportDetails.selectDisposition;
                    document.getElementById('selectNotification').value = ncr.reportDetails.selectNotification;
                    document.getElementById('origRevNum').value = ncr.engineeringDetails.origRevNum;
                    document.getElementById('txtEngName').value = ncr.engineeringDetails.engineerName;
                    document.getElementById('status').value = ncr.engineeringDetails.status;
                    document.getElementById('txtOrgRevNo').value = ncr.reportDetails.origRevNum;
                    document.getElementById('txtupRevNo').value = ncr.reportDetails.updateRevNum;

                    if(ncr.engineeringDetails.needRedraw === 'yes'){
                        document.getElemetById('rdoRedrawYes').checked = true;
                    }else{
                        document.getElementById('rdoRedrawNo').checked = true;
                    }
                }
            }
        });
    </script>


</body>

</html>